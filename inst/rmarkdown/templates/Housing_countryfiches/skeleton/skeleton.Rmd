---
output:
  pdf_document:
    highlight: tango
    keep_tex: false
    includes:
      in_header: "preamble.tex"
params:
  ctry_code: FRA
  ctry_name: France
  title: Housing Horizontal Project
---

```{r set_up, include=F}
#global parameters for knit
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(fig.align = "center")
knitr::opts_chunk$set(fig.height =  5)
knitr::opts_chunk$set(fig.width = 8)
#R package dependencies
library(devtools)
library(ggplot2)
library(rio)
library(dplyr)
library(plotly)
library(forcats)
library(lubridate)
library(ggrepel)
library(stringr)
library(fmsb)
library(countrycode)
library(tidyr)
library(OECDHousingToolkit)
library(rLDCP)


```

```{r import data}

data("htk_paragraphs")
dt=htk_paragraphs
data("htk_Polvars")
data_polvar=htk_Polvars

data("htk_Outcomevars")
#all_vars=htk_Outcomevars

 all_vars=rio::import("../../../../../data/all_clean_cf_data0715.xlsx")
 catalogue<-rio::import("../../../../../data/catalogue.xlsx")

rm(htk_Polvars)
rm(htk_paragraphs)
rm(htk_Outcomevars)

all_vars <- all_vars %>% mutate(country_name=countrycode(iso3,origin="iso3c",destination="country.name"))

all_vars <- all_vars %>%  select(iso3, country_name, everything()) 
all_vars <- subset(all_vars, !is.na(country_name)  )

  #mutate(country_name= ifelse( iso3=="OECD", "OECD", country_name), 
   #      country_name= ifelse( iso3=="EUU", "EUU", country_name), 
    #     country_name= ifelse( iso3=="OECD", "OECD", country_name))

all_vars <- all_vars  %>%
  rename(Iso_code3=iso3)

all_vars=all_vars %>% gather(key=key,value=value,-c("Iso_code3","country_name")) %>% group_by(Iso_code3) %>%
  mutate(dispo_var=mean(ifelse(!is.na(value),1,0))) %>% spread(key=key,value) %>% ungroup() %>% data.frame()

```


\chead{
 \rule[-1.75\baselineskip]{0pt}{0pt}
  \includegraphics[height=4\baselineskip,valign=c]{OECDlogo.jpg}
  \quad% Space
   Housing Sector Country Fiche}

\newpage
\bigskip

\color{ultramarineblue}

\section{Housing Sector Outcomes: \Large `r params$ctry_name`}

\color{black}

The provision of efficient, sustainable and inclusive housing is crucial for the well-being of citizens. Housing markets affect peopleâ€™s well-being through a wide range of channels including access to decent shelter, environmental quality, efficient use of scarce resources, type and extent of commuting or its contribution to strong and resilient economic growth. Galloping urbanisation coupled with increasing awareness for negative externalities arising from commuting and urban sprawl have put strain on housing markets and their capacity to deliver affordable housing to all while reducing environmental and health costs for current and future generations. 


\begin{multicols}{3}

\color{Goldenrod}
\begin{center}
\section{Efficiency}
\end{center}

```{r Efficiency}
# select the variables according to the ranking 
mycategory="efficiency"
effic_vars<-catalogue  %>%  filter(category==mycategory) %>%  
                            filter(type=="outcome")
ranking_eff<-effic_vars  %>% select(variable, rank,direction, variable_name)
ranking_eff<-ranking_eff   %>% mutate(variable_name=gsub("*","\n",ranking_eff$variable_name, fixed = T))
var_codes_eff<-c(effic_vars$variable) # only select ALL efficiency variables 
var_names_eff<-c(ranking_eff$variable_name) # only the efficiency ones
var_direction_eff<-c(ranking_eff$direction) # only the efficiency ones
dt_effic<-all_vars %>% select(Iso_code3,country_name, var_codes_eff) 
sec_col_eff=c("goldenrod")

htk_CyC(dt_effic, ranking_eff, params$ctry_code,var_codes_eff,var_names_eff, sec_col_eff, title="Efficiency Outcomes")

```

\color{black}
```{r Efficiency paragraph, results='asis',include=F}
dt=htk_text_generator(data=dt_effic,
                      category=mycategory,
                      ranking=ranking_eff,
                      ctry=params$ctry_code,
                      var_codes=var_codes_eff,
                      var_names=var_names_eff)

paragraph=dt %>% dplyr::select(mycategory)
paragraph=gsub("\n","",paragraph)

```


\footnotesize
```{r Efficiency paragraph results, results='asis'}
cat(paragraph)
```


\columnbreak

\color{ProcessBlue}
\begin{center}
\section{Inclusiveness}
\end{center}

\color{black}

```{r Inclusiveness}
mycategory="inclusiveness"
incl_vars<-catalogue  %>%  filter(category==mycategory) %>%  
                            filter(type=="outcome")
ranking_incl<-incl_vars  %>% select(variable, rank,direction, variable_name)
ranking_incl<-ranking_incl   %>% mutate(variable_name=gsub("*","\n",ranking_incl$variable_name, fixed = T))
var_codes_incl<-c(incl_vars$variable) # only select ALL efficiency variables 
var_names_incl<-c(ranking_incl$variable_name) # only the efficiency ones
dt_incl<-all_vars %>% select(Iso_code3,country_name, var_codes_incl) 
sec_col=c("deepskyblue")

htk_CyC(dt_incl,ranking_incl, params$ctry_code,var_codes_incl,var_names_incl,sec_col, title="Inclusiveness Outcomes")
```


```{r Inclusiveness paragraph, results='asis',include=F}

dt=htk_text_generator(data=dt_incl,
                      category=mycategory,
                      ranking=ranking_incl,
                      ctry=params$ctry_code,
                      var_codes=var_codes_incl,
                      var_names=var_names_incl)

paragraph=dt %>% dplyr::select(mycategory)
paragraph=gsub("\n","",paragraph)
```


```{r Inclusiveness paragraph results, results='asis'}
cat(paragraph)
```

\columnbreak

\color{Green}

\begin{center}
\section{Sustainability}
\end{center}

\color{black}

```{r Sustainability}
mycategory="sustainability"
sust_vars<-catalogue  %>%  filter(category==mycategory) %>%  
                            filter(type=="outcome")
ranking_sust<-sust_vars  %>% select(variable, rank,direction, variable_name)
ranking_sust<-ranking_sust   %>% mutate(variable_name=gsub("*","\n",ranking_sust$variable_name, fixed = T))
var_codes_sust<-c(sust_vars$variable) # only select ALL sust variables 
var_names_sust<-c(ranking_sust$variable_name) # only the efficiency ones
dt_sust<-all_vars %>% select(Iso_code3,country_name, var_codes_sust) 
sec_col=c("darkgreen")


htk_CyC(dt_sust,ranking_sust, params$ctry_code,var_codes_sust,var_names_sust, sec_col, title="Sustainability Outcomes")
```

```{r Sustainability paragraph, results='asis',include=F}

dt=htk_text_generator(data=dt_sust,
                      category=mycategory,
                      ranking=ranking_sust,
                      ctry=params$ctry_code,
                      var_codes=var_codes_sust,
                      var_names=var_names_sust)

paragraph=dt %>% dplyr::select(mycategory)
paragraph=gsub("\n","",paragraph)
```

```{r Sustainability paragraph results, results='asis'}
cat(paragraph)
```


\end{multicols}



\newpage

\begin{tabular}{l  l}
\parbox[t]{0.35\textwidth}{
\color{ultramarineblue}
\section{Housing Sector Policies Variables:}

\color{black}
\lipsum[2-2]
\bigskip

```{r fig.height =  6,fig.width = 6,fig.align="center"}
#correct legend that as potentially an error
htk_policyradar(data_polvar,params$ctry_code)
```
}
&
\parbox[t]{0.2\textwidth}{
\color{ultramarineblue}
\section{Definitions}
\color{black}
\footnotesize
\begin{tabular}{ l p{11cm} }
\hline
\hline
\multicolumn{2}{c}{}        \\
\multicolumn{2}{c}{\color{Goldenrod}\bf{Efficiency}}        \\
\multicolumn{2}{c}{}        \\
\color{Goldenrod}\bf {Residential Investment} & Difference in number of dwellings that were completed during a given year  \\
& and are ready to be occupied between two consecutive quarters \\
\color{Goldenrod}\bf {House Price Volatility} & Standard deviation of (real) house price index  \\
\color{Goldenrod}\bf {Price to income} &  Ratio between (real) house price index and median  yearly income \\
& \\
\color{Goldenrod}\bf {Mortgage claims} &  add definition \\
& \\
\multicolumn{2}{c}{\color{ProcessBlue}\bf{Inclusiveness}}        \\
\multicolumn{2}{c}{}        \\
\color{ProcessBlue}\bf{  Home ownership}  & add definition \\
\color{ProcessBlue}\bf{  Over-crowding } & Percentage of household that does not have at its disposal a minimum \\ 
& number of rooms \\
\color{ProcessBlue}\bf{  Over burden } & add definition  \\
 & \\
\multicolumn{2}{c}{\color{Green}\bf{Sustainability}}        \\
\multicolumn{2}{c}{}        \\
\color{Green}\bf{  Local air pollution} & Presence of contaminant or pollutant substances in the air that do not \\ 
& disperse properly and that interfere with human health or welfare, \\
& or produce other harmful environmental effects \\
\color{Green}\bf{  $CO_{2}$ emission} & Product of fuel efficiency and the carbon intensity per kWh.5  \\
\color{Green}\bf{  Urban sprawl} & Low average urban population density  \\
& \\
\multicolumn{2}{c}{\color{ultramarineblue}\bf{Policy}}        \\
\multicolumn{2}{c}{}        \\
\color{ultramarineblue}\bf {Rent control stringency} & The rent control indicator measures the extent of rental regulation \\
& in the private rental market by country. \\
& It considers the presence of controls on rent levels and rent increases   \\
\color{ultramarineblue}\bf {Tenant protection} &  The tenant protection indicator considers the ease of tenant eviction, \\
& tenure security and deposit requirement \\
\color{ultramarineblue}\bf {Social housing} & Share of public expenditure on social housing \\
\color{ultramarineblue}\bf {LTV } & Maximum loan-to-value ratio \\
\color{ultramarineblue}\bf {METR mortgage } & Marginal effective tax rate on mortgage \\
\color{ultramarineblue}\bf {Building and energy} & Definition to find \\
\color{ultramarineblue}\bf {code stringency} &   \\
\color{ultramarineblue}\bf {Planning system} & Definition to find \\
\hline
\hline
\end{tabular}
}
\end{tabular}

